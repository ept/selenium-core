<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>UI-Element Test</title>
    <script language="JavaScript" type="text/javascript" src="../../jsunit/app/jsUnitCore.js"></script>
    <!-- includes for MozillaBrowserBot -->
    <script language="JavaScript" type="text/javascript" src="../../core/scripts/htmlutils.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/scripts/ui-element.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/scripts/selenium-browserbot.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/scripts/selenium-browserdetect.js"></script>
    <!-- includes for ajaxslt -->
    <script language="JavaScript" type="text/javascript" src="../../core/xpath/util.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/xpath/xmltoken.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/xpath/dom.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../core/xpath/xpath.js"></script>
    <!-- includes for Selenium -->
    <script language="JavaScript" type="text/javascript" src="../../core/scripts/selenium-api.js"></script>
    <!-- end includes -->
    <script type="text/javascript">

function test_UIElement_validate()
{
    var uiElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , xpath: '//a'
    });
    
    // happy path 1
    uiElement.validate({ name: 'name', description: 'desc', xpath: '//a' });
    
    // happy path 2
    uiElement.validate({ name: 'name', description: 'desc',
        getLocator: function(args) { return '//a'; } });
    
    // destructive: no name
    try {
        uiElement.validate({ description: 'desc', xpath: '//a' });
        fail('Expected UIElementException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIElementException', e.name);
    }
    
    // destructive: no description
    try {
        uiElement.validate({ name: 'name', xpath: '//a' });
        fail('Expected UIElementException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIElementException', e.name);
    }
    
    // destructive: no xpath
    try {
        uiElement.validate({ name: 'name', description: 'desc' });
        fail('Expected UIElementException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIElementException', e.name);
    }
}



function test_UIElement_init()
{
    // name, description, args, getLocator, testcases, getDefaultLocators
    var uiElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , xpath: '//a'
    });
    
    // happy path 1
    uiElement.init({ name: 'name', description: 'desc', xpath: '//a' });
    assertEquals('name', uiElement.name);
    assertEquals('desc', uiElement.description);
    assertTrue(are_equal([], uiElement.args));
    assertEquals('//a', uiElement.getLocator());
    assertTrue(are_equal([], uiElement.getTestcases()));
    assertTrue(are_equal({ '//a': {} }, uiElement.getDefaultLocators()));
    
    // happy path 2
    uiElement.init({ name: 'name', description: 'desc',
        getLocator: function() { return '//a'; } });
    assertEquals('name', uiElement.name);
    assertEquals('desc', uiElement.description);
    assertTrue(are_equal([], uiElement.args));
    assertEquals('//a', uiElement.getLocator());
    assertTrue(are_equal([], uiElement.getTestcases()));
    assertTrue(are_equal({ '//a': {} }, uiElement.getDefaultLocators()));
    
    // happy path 3
    uiElement.init({ name: 'name', description: 'desc', args: [],
        xpath: '//a', testcase1: { args: {},
        xhtml: '<a expected-result="1" />' } });
    assertEquals('name', uiElement.name);
    assertEquals('desc', uiElement.description);
    assertTrue(are_equal([], uiElement.args));
    assertEquals('//a', uiElement.getLocator());
    assertTrue(are_equal([ { name: 'testcase1', args: {},
        xhtml: '<a expected-result="1" />' } ], uiElement.getTestcases()));
    assertTrue(are_equal({ '//a': {} }, uiElement.getDefaultLocators()));
}



function test_UIElement_permuteArgs()
{
    var testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: [
            {
                name: 'arg1',
                description: 'desc1',
                defaultValues: [4, 'g', '*']
            },
            {
                name: 'arg2',
                description: 'desc2',
                defaultValues: []
            },
            {
                name: 'arg3',
                description: 'desc3',
                defaultValues: ['%', 0, 'q']
            }
        ]
        , getLocator: function(args) { return '//a'; }
    });
    
    assertTrue(are_equal(
        [
            {arg1: '4', arg3: '%'},
            {arg1: '4', arg3: '0'},
            {arg1: '4', arg3: 'q'},
            {arg1: 'g', arg3: '%'},
            {arg1: 'g', arg3: '0'},
            {arg1: 'g', arg3: 'q'},
            {arg1: '*', arg3: '%'},
            {arg1: '*', arg3: '0'},
            {arg1: '*', arg3: 'q'}
        ],
        testUIElement.permuteArgs(testUIElement.args))
    );
}



function test_UIElement_getTestcases()
{
    var testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: []
        , getLocator: function(args) {
            return "//div[@id='content']";
        }
        , testcase1: {
            xhtml: '<div id="content" expected-result></div>'
        }
        , testcase2: {
            xhtml: '<div id="main"><div id="content" expected-result>'
                + '</div></div>'
        }
    });
    
    assertTrue(are_equal([
        {name: 'testcase1', xhtml: '<div id="content" expected-result></div>'},
        {name: 'testcase2', xhtml: '<div id="main"><div id="content" expected-result></div></div>'}],
        testUIElement.getTestcases()));
}



function test_UIElement_test()
{
    var testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: []
        , getLocator: function(args) {
            return "//div[@id='content']";
        }
        , testcase1: {
            xhtml: '<div id="content" expected-result="1"></div>'
        }
        , testcase2: {
            xhtml: '<div id="main"><div id="content" expected-result="1">'
                + '</div></div>'
        }
    });
    assertTrue(testUIElement.test());
    
    // more complicated
    testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: [
            {
                name: 'index'
                , description: 'the index'
                , defaultValues: []
            }
        ]
        , getLocator: function(args) {
            return "//div[@id='section" + args['index'] + "']";
        }
        , testcase1: {
            args: { index: 1 }
            , xhtml: '<div id="section1" expected-result="1"></div>'
        }
        , testcase2: {
            args: { index: 42 }
            , xhtml: '<div id="section1"><div id="section42" expected-result="1">'
                + '</div></div>'
        }
    });
    assertTrue(testUIElement.test());
    
    // destructive
    testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: [
            {
                name: 'index'
                , description: 'the index'
                , defaultValues: []
            }
        ]
        , getLocator: function(args) {
            return "//div[@id='section" + args['index'] + "']";
        }
        , testcase1: {
            args: { index: 1 }
            , xhtml: '<div id="section4" expected-result="1"></div>'
        }
    });
    assertFalse(testUIElement.test());
}


function test_UIElement_initDefaultXPaths()
{
    var testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: [
            {
                name: 'arg1',
                description: 'desc1',
                defaultValues: [4, 'g', '*']
            },
            {
                name: 'arg2',
                description: 'desc2',
                defaultValues: []
            },
            {
                name: 'arg3',
                description: 'desc3',
                defaultValues: ['%', 0, 'q']
            }
        ]
        , getLocator: function(args) {
            return "//div[@id='" + args['arg1'] + "']/" +
                (args['arg2'] ? args['arg2'] : 'span') +
                "[@class='" + args['arg3'] + "']/a";
        }
    });
    assertTrue(are_equal(
        {
            "//div[@id='4']/span[@class='%']/a": {arg1: '4', arg3: '%'},
            "//div[@id='4']/span[@class='0']/a": {arg1: '4', arg3: '0'},
            "//div[@id='4']/span[@class='q']/a": {arg1: '4', arg3: 'q'},
            "//div[@id='g']/span[@class='%']/a": {arg1: 'g', arg3: '%'},
            "//div[@id='g']/span[@class='0']/a": {arg1: 'g', arg3: '0'},
            "//div[@id='g']/span[@class='q']/a": {arg1: 'g', arg3: 'q'},
            "//div[@id='*']/span[@class='%']/a": {arg1: '*', arg3: '%'},
            "//div[@id='*']/span[@class='0']/a": {arg1: '*', arg3: '0'},
            "//div[@id='*']/span[@class='q']/a": {arg1: '*', arg3: 'q'}
        },
        testUIElement.getDefaultLocators())
    );
    
    testUIElement = new UIElement({
        name: 'name'
        , description: 'desc'
        , args: []
        , getLocator: function(args) { return "//div[@id='content']"; }
    });
    assertTrue(are_equal(
        {
            "//div[@id='content']": {}
        },
        testUIElement.getDefaultLocators())
    );
}



function test_UIArgument_validate()
{
    var uiArgument = new UIArgument({ name: 'name'
        , description: 'desc'
        , defaultValues: [1, 2]
    });
    
    // happy path 1
    uiArgument.validate({ name: 'name'
        , description: 'desc'
        , defaultValues: [1, 2]
    });
    
    // happy path 2
    uiArgument.validate({ name: 'name'
        , description: 'desc'
        , getDefaultValues: function() { return [1, 2]; }
    });
    
    // destructive: no name
    try {
        uiArgument.validate({ description: 'desc', defaultValues: [1, 2] });
        fail('Expected UIArgumentException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIArgumentException', e.name);
    }
    
    // destructive: no description
    try {
        uiArgument.validate({ name: 'name', defaultValues: [1, 2] });
        fail('Expected UIArgumentException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIArgumentException', e.name);
    }
    
    // destructive: no default values
    try {
        uiArgument.validate({ name: 'name', description: 'desc' });
        fail('Expected UIArgumentException, but none was thrown');
    }
    catch (e) {
        assertEquals('UIArgumentException', e.name);
    }
}


function test_UIArgument_init()
{
    var uiArgument = new UIArgument({ name: 'name'
        , description: 'desc'
        , defaultValues: []
    });
    var localVars = { _foo: 'bar' };
    
    // happy path 1: specifying defaultValues
    uiArgument.init({ name: 'name', description: 'desc', defaultValues: [1, 2]},
        localVars);
    assertEquals('name', uiArgument.name);
    assertEquals('desc', uiArgument.description);
    assertTrue(are_equal([1, 2], uiArgument.getDefaultValues()));
    assertEquals('bar', uiArgument._foo);
    
    // happy path 2: specifying getDefaultValues()
    uiArgument.init({ name: 'name', description: 'desc',
        getDefaultValues: function() { return [1, 2]; } }, localVars);
    assertEquals('name', uiArgument.name);
    assertEquals('desc', uiArgument.description);
    assertTrue(are_equal([1, 2], uiArgument.getDefaultValues()));
    assertEquals('bar', uiArgument._foo);
}



// test the UISpecifier constructor. In particular, make sure that the
// components of the UI specifier are created correctly: path, elementName,
// and args. The string can be tested in the tests for UISpecifier methods.
function test_UISpecifier()
{
    // construct from a UI specifier string
    var testUISpecifier =
        new UISpecifier('pagesetName::elementName(k1=v1, k2=v2)');
    assertEquals('pagesetName', testUISpecifier.pagesetName);
    assertEquals('elementName', testUISpecifier.elementName);
    assertTrue(are_equal({k1: 'v1', k2: 'v2'}, testUISpecifier.args));
    
    // construct from components
    testUISpecifier = new UISpecifier('pagesetName', 'elementName',
        {k1: 'v1', k2: 'v2'});
    assertEquals('pagesetName', testUISpecifier.pagesetName);
    assertEquals('elementName', testUISpecifier.elementName);
    assertTrue(are_equal({k1: 'v1', k2: 'v2'}, testUISpecifier.args));
}



function test_UISpecifier__initFromUISpecifierString()
{
    var testUISpecifier = new UISpecifier('pagesetName::elementName()');
    assertEquals('pagesetName', testUISpecifier.pagesetName);
    assertEquals('elementName', testUISpecifier.elementName);
    assertTrue(are_equal({}, testUISpecifier.args));
    
    testUISpecifier._initFromUISpecifierString('pagesetName::elementName(k1=v1, k2=v2)');
    assertEquals('pagesetName', testUISpecifier.pagesetName);
    assertEquals('elementName', testUISpecifier.elementName);
    assertTrue(are_equal({k1: 'v1', k2: 'v2'}, testUISpecifier.args));
    
    testUISpecifier._initFromUISpecifierString('complex:. pagesetName  ::# elementName:*@  ( k1 = v1 ,  k  2=v2   )');
    assertEquals('complex:. pagesetName  ', testUISpecifier.pagesetName);
    assertEquals('# elementName:*@  ', testUISpecifier.elementName);
    assertTrue(are_equal({k1: 'v1', 'k  2': 'v2'}, testUISpecifier.args));
    
    // destructive
    try {
        testUISpecifier._initFromUISpecifierString('pagesetName::()');
        fail('Expected UISpecifierException, but none was thrown: missing element name');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
    try {
        testUISpecifier._initFromUISpecifierString('elementName()');
        fail('Expected UISpecifierException, but none was thrown: missing pageset name');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
    try {
        testUISpecifier._initFromUISpecifierString('pagesetName::elementName');
        fail('Expected UISpecifierException, but none was thrown: missing arguments');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
    try {
        testUISpecifier._initFromUISpecifierString('pagesetName::elementName(k1=v1, k2=v2');
        fail('Expected UISpecifierException, but none was thrown: missing close parenthesis for arguments');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
}



function test_UISpecifier_toString()
{
    var testUISpecifier = new UISpecifier('pagesetName::elementName()');

    // round-tripping the unique test_UISpecifier__initFromUISpecifierString() cases
    var inputs = [
        {pagesetName: 'pagesetName', elementName: 'elementName', args: {}},
        {pagesetName: 'pagesetName', elementName: 'elementName', args: {k1: 'v1', k2: 'v2'}},
        {pagesetName: 'complex:. pagesetName  ', elementName: '# elementName:*@  ', args: {k1: 'v1', 'k  2': 'v2'}}
    ];
    
    for (var i = 0; i < inputs.length; ++i) {
        testUISpecifier.pagesetName = inputs[i].pagesetName;
        testUISpecifier.elementName = inputs[i].elementName;
        testUISpecifier.args = inputs[i].args;
        var testUISpecifier2 = new UISpecifier(testUISpecifier.toString());
        assertEquals(inputs[i].pagesetName, testUISpecifier2.pagesetName);
        assertEquals(inputs[i].elementName, testUISpecifier2.elementName);
        assertTrue(are_equal(inputs[i].args, testUISpecifier2.args));
    }
    
    // destructive
    try {
        testUISpecifier.pagesetName = undefined;
        testUISpecifier.elementName = 'elementName';
        testUISpecifier.args = {};
        testUISpecifier.toString();
        fail('Expected exception but none was thrown: undefined pageset name');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
    try {
        testUISpecifier.pagesetName = 'pagesetName';
        testUISpecifier.elementName = '';
        testUISpecifier.args = {};
        testUISpecifier.toString();
        fail('Expected exception but none was thrown: empty element name');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
    try {
        testUISpecifier.pagesetName = 'pagesetName';
        testUISpecifier.elementName = 'elementName';
        testUISpecifier.args = null;
        testUISpecifier.toString();
        fail('Expected exception but none was thrown: empty arguments array');
    }
    catch (e) {
        assertEquals('UISpecifierException', e.name);
    }
}



function test_Pageset_init()
{
    var pageset = new Pageset({
        name: 'name'
        , description: 'desc'
        , paths: [ 'foo' ]
    });
    
    // happy path 1
    pageset.init({
        name: 'name'
        , description: 'desc'
        , pathPrefix: 'foo/'
        , paths: [ 'bar', 'baz', 'shizzle.py' ]
    });
    assertEquals('name', pageset.name);
    assertEquals('desc', pageset.description);
    assertEquals('^foo\\/(?:bar|baz|shizzle\\.py)$', pageset.pathRegexp.source);
    assertTrue(are_equal({}, pageset.paramRegexps));
    
    // happy path 2
    pageset.init({
        name: 'name'
        , description: 'desc'
        , pathPrefix: 'no.way.'
        , pathRegexp: 'to.e'
        , paramRegexps: { id: 'wallabee', type: '(?:medium|large)' }
    });
    assertEquals('name', pageset.name);
    assertEquals('desc', pageset.description);
    assertEquals('^no\\.way\\.(?:to.e)$', pageset.pathRegexp.source);
    assertEquals('wallabee', pageset.paramRegexps.id.source);
    assertEquals('(?:medium|large)', pageset.paramRegexps.type.source);

    // happy path: paths only
    pageset.init({
        name: 'name'
        , description: 'desc'
        , paths: [ 'just.html', 'do.html', 'it.html' ]
    });
    assertEquals('name', pageset.name);
    assertEquals('desc', pageset.description);
    assertEquals('^(?:just\\.html|do\\.html|it\\.html)$',
        pageset.pathRegexp.source);
    
    // happy path: pathRegexp only
    pageset.init({
        name: 'name'
        , description: 'desc'
        , pathRegexp: '.+\\.rb'
    });
    assertEquals('name', pageset.name);
    assertEquals('desc', pageset.description);
    assertEquals('^(?:.+\\.rb)$', pageset.pathRegexp.source);
    
    // omitting both paths and pathRegexp isn't allowed now, but we might allow
    // it in the future
    try {
        pageset.init({
            name: 'name'
            , description: 'desc'
            , pathPrefix: 'helloWorld'
        });
        fail('PagesetException expected but not thrown');
    }
    catch (e) {
        assertEquals('PagesetException', e.name);
    }
}



function test_Pageset_contains()
{
    var pageset = new Pageset({
        name: 'name'
        , description: 'desc'
        , pathRegexp: '.*(?:foo|bar).*'
    });
    var mockDoc = { location: {} };
    mockDoc.location.href = 'http://w3.org/food';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/beach/sandbar.php';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://foo.org/baz.html';
    assertFalse(pageset.contains(mockDoc));
    
    pageset = new Pageset({
        name: 'name'
        , description: 'desc'
        , pathRegexp: '.*(?:foo|bar).*'
        , paramRegexps: { 'baz': 'yea' }
    });
    mockDoc.location.href = 'http://w3.org/food?baz=hellyeah';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/beach/sandbar.php?lang=zh_CN&baz=yeahbuddy';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/fool';
    assertFalse(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/bar.mitzvah?baz=hag'
    assertFalse(pageset.contains(mockDoc));
    
    pageset = new Pageset({
        name: 'name'
        , description: 'desc'
        , pathPrefix: 'prefix/'
        , paths: [ 'onepath', 'twopath' ]
    });
    mockDoc.location.href = 'http://w3.org/prefix/onepath';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/prefix/onepath';
    assertTrue(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/prefix/';
    assertFalse(pageset.contains(mockDoc));
    mockDoc.location.href = 'http://w3.org/prefix/foo';
    assertFalse(pageset.contains(mockDoc));
    
    pageset = new Pageset({
        name: 'name'
        , description: 'desc'
        , pathRegexp: '.*'
        , pageContent: function(inDocument) {
            var tags = inDocument.getElementsByTagName('script');
            for (var i = 0; i < tags.length; ++i) {
                if (/ui-element\.js$/.test(tags[i].src)) {
                    return true;
                }
            }
            return false;
        }
    });
    assertTrue(pageset.contains(document));
}



function test_Pageset_validate()
{
    // no name
    try {
        new Pageset({ description: 'desc', paths: [ 'foo' ] });
        fail('Expected PagesetException, but none was thrown');
    }
    catch (e) {
        assertEquals('PagesetException', e.name);
    }
    
    // no description
    try {
        new Pageset({ name: 'name', paths: [ 'foo' ] });
        fail('Expected PagesetException, but none was thrown');
    }
    catch (e) {
        assertEquals('PagesetException', e.name);
    }
    
    // no paths, pathRegexp, or pageContent
    try {
        new Pageset({ name: 'name', description: 'desc' });
        fail('Expected PagesetException, but none was thrown');
    }
    catch (e) {
        assertEquals('PagesetException', e.name);
    }
    
    // happy paths
    new Pageset({ name: 'name', description: 'desc', paths: [ 'foo' ] });
    new Pageset({ name: 'name', description: 'desc', pathRegexp: 'bar' });
    new Pageset({ name: 'name', description: 'desc', pageContent: function() { return true; } });
}



function test_UIMap_getUIElementsByUrl()
{
    var myMap = new UIMap(true);
    
    assertTrue(myMap.addPageset({
        name: 'ishPages'
        , description: 'pages whose URLs end with "ish"'
        , pathRegexp: '.*ish'
    }));
    assertTrue(myMap.addElement('ishPages', {
        name: 'someElement'
        , description: 'some real element'
        , args: []
        , getLocator: function(args) { return "//input"; }
    }));
    
    // it's ugly, but it give us coverage! Test "this" in the getDefaultValues()
    // and getLocator() methods.
    assertTrue(myMap.addPageset({
        name: 'discPages'
        , description: 'pages whose URLs start with "disc"'
        , pathRegexp: 'disc.*'
    }));
    assertTrue(myMap.addElement('discPages', {
        name: 'anElement'
        , description: 'a real element'
        , args: [
            {
                name: 'name'
                , description: 'desc'
                , getDefaultValues: function() { return keys(this._map); }
            }
        ]
        , getLocator: function(args) {
            var name = this._map[args['name']];
            return "//div[@id='" + name + "']";
        }
        , _map: {
            foo: 'bar'
            , baz: 'hep'
        }
    }));
    var uiElement = myMap.getUIElement('discPages', 'anElement');
    assertTrue(are_equal(['foo', 'baz'], uiElement.args[0].getDefaultValues()));
    assertEquals("//div[@id='hep']", uiElement.getLocator({name: 'baz'}));
    
    // test forthcoming ...
}



function test_CommandMatcher_validate()
{
    // no target
    try {
        new CommandMatcher({ command: 'command' });
        fail('Expected CommandMatcherException, but none was thrown');
    }
    catch (e) {
        assertEquals('CommandMatcherException', e.name);
    }

    // no command
    try {
        new CommandMatcher({ target: 'target' });
        fail('Expected CommandMatcherException, but none was thrown');
    }
    catch (e) {
        assertEquals('CommandMatcherException', e.name);
    }
    
    // minMatches > maxMatches
    try {
        new CommandMatcher({
            command: 'command'
            , target: 'target'
            , minMatches: 5
            , maxMatches: 1
        });
        fail('Expected CommandMatcherException, but none was thrown');
    }
    catch (e) {
        assertEquals('CommandMatcherException', e.name);
    }
    
    // happy path
    new CommandMatcher({ command: 'command', target: 'target' });
}

function test_CommandMatcher_init()
{
    var f = function() { };

    // happy path, all elements
    var cm = new CommandMatcher({
        command: 'command'
        , target: 'target'
        , value: 'value'
        , minMatches: 1
        , maxMatches: 5
        , updateArgs: f
    });
    assertEquals('command', cm.command);
    assertEquals('target', cm.target);
    assertEquals('value', cm.value);
    assertEquals(1, cm.minMatches);
    assertEquals(5, cm.maxMatches);
    assertEquals(f, cm.updateArgs);
    
    // leave out all non-required fields
    cm = new CommandMatcher({ command: 'command', target: 'target' });
    assertEquals('command', cm.command);
    assertEquals('target', cm.target);
    assertNull(cm.value);
    assertEquals(1, cm.minMatches);
    assertEquals(1, cm.maxMatches);
    assertNotUndefined(cm.updateArgs);
}

function test_CommandMatcher_match()
{
    // test matching on command, target, and value using regular expressions.
    // Assert on the arguments object being updated correctly.
    var cm = new CommandMatcher({
        command: 'click.*'
        , target: 'ui=allPages::.+'
        , value: '\\d{4}'
    });
    
    // happy path
    var command = {
        command: 'clickAndWait'
        , target: 'ui=allPages::help()'
        , value: '2085'
    };
    assertTrue(cm.isMatch(command));
    
    // sad path 1: failed command
    command.command = 'type';
    assertFalse(cm.isMatch(command));
    
    // sad path 2: failed target
    command.command = 'click';
    command.target = 'password';
    assertFalse(cm.isMatch(command));
    
    // sad path 3: failed value
    command.target = 'ui=allPages::faq()';
    command.value = 'asdf';
    assertFalse(cm.isMatch(command));
}



function test_RollupRule_getRollup()
{
    var rule = new RollupRule({
        name: 'name'
        , description: 'desc'
        , commandMatchers: [
            {
                command: 'cmd1'
                , target: 'tar\\d'
            }
            , {
                command: 'cmd2'
                , target: '[Tt]ar2'
                , value: '\\$.*'
            }
        ]
        , expandedCommands: []
    });
    
    // exact match
    var commands = [
        new Command('cmd1', 'tar1', '')
        , new Command('cmd2', 'Tar2', '$5')
    ];
    var result = rule.getRollup(commands);
    assertEquals('rollup', result.command);
    assertEquals('name', result.target);
    assertEquals('', result.value);
    assertTrue(are_equal([ 0, 1 ], result.replacementIndexes));
    
    // now we set maxMatches, and have multiple matches for the first
    // CommandMatcher
    rule.commandMatchers[0].maxMatches = 5;
    rule.commandMatchers[0].updateArgs = function(command, args) {
        if (args.count) {
            ++args.count;
        }
        else {
            args.count = 1;
        }
        return args;
    };
    commands.unshift(new Command('cmd1', 'tar0'));
    commands.unshift(new Command('cmd1', 'tar9'));
    result = rule.getRollup(commands);
    assertTrue(are_equal({ count: '3' }, parse_kwargs(result.value)));
    assertTrue(are_equal([ 0, 1, 2, 3 ], result.replacementIndexes));
    
    // now we add non-matching commands after
    commands.push(new Command('cmd1', 'target'));
    commands.push(new Command('cmd2', 'tar2', 'dro$$'));
    result = rule.getRollup(commands);
    assertTrue(are_equal({ count: '3' }, parse_kwargs(result.value)));
    assertTrue(are_equal([ 0, 1, 2, 3 ], result.replacementIndexes));
    
    // now we set minMatches. The first test should fail to match.
    rule.commandMatchers[1].minMatches = 2;    
    rule.commandMatchers[1].maxMatches = 5;
    rule.commandMatchers[1].updateArgs = function(command, args) {
        if (args.count2) {
            ++args.count2;
        }
        else {
            args.count2 = 1;
        }
        return args;
    };
    result = rule.getRollup(commands);
    assertFalse(result);
    
    // this test uses commands that satisfy the minMatches.
    commands.splice(4, 0, new Command('cmd2', 'tar2', '$_'));
    result = rule.getRollup(commands);
    assertTrue(are_equal({ count: '3', count2: '2' },
        parse_kwargs(result.value)));
    assertTrue(are_equal([ 0, 1, 2, 3, 4 ], result.replacementIndexes));
    
    // test the alternate command replacement
    rule = new RollupRule({
        name: 'btnG'
        , description: 'desc'
        , alternateCommand: 'clickAndWait'
        , commandMatchers: [
            {
                command: 'click'
                , target: 'btnG'
            }
        ]
        , expandedCommands: []
    });
    commands = [ new Command('click', 'btnG') ];
    result = rule.getRollup(commands);
    assertEquals('clickAndWait', result.command);
    assertEquals('btnG', result.target);
}

    </script>
</head>

<body>

<a id="id1" href="#id1">this is the first element</a>
</body>
</html>

