<project name="selenium" default="dist" xmlns:maven="urn:maven-artifact-ant">

    <property name="version" value="0.7-SNAPSHOT"/>

    <target name="all" depends="install-jar, dist"/>

    <property name="resultshandler.path.prefix" value=""/>
    <property name="svnversion.executable" value="svnverion"/>
    <property name="ruby.executable" value="/usr/bin/ruby"/>

    <property name="build.dir" location="../build"/>
    <property name="dist.dir" location="${build.dir}/dist"/>
    <property name="image.dir" location="${build.dir}/image"/>
    <property name="resultshandler.image.dir" location="${build.dir}/resultshandler"/>

    <target name="clean">
        <delete dir="${build.dir}"/>
    </target>

    <target name="get-svn-revision">
        <exec executable="${svnversion.executable}" outputProperty="svn-revision" failIfExecutionFails="true"/>
        <echo message="Got svn revision: ${svn-revision}"/>
    </target>

    <target name="copy-sources">
        <property name="svn-revision" value="unknown-revision"/>
        <copy todir="${image.dir}">
            <fileset dir="javascript">
                <exclude name="jsunit/intellij/**"/>
                <exclude name="jsunit/java/**"/>
                <exclude name="jsunit/tests/**"/>
            </fileset>
            <filterset>
                <filter token="VERSION" value="${version}"/>
                <filter token="REVISION" value="${svn-revision}"/>
            </filterset>
        </copy>
    </target>

    <target name="generate-xml">
        <exec executable="cscript" dir="javascript" output="${image.dir}/core/iedoc.xml" failonerror="true">
            <arg value="/nologo"/>
            <arg file="javascript/iedoc.js"/>
        </exec>
        <xmlvalidate file="${image.dir}/core/iedoc.xml" lenient="true"/>
    </target>

    <target name="generate-doc" depends="generate-xml">
        <xslt in="${image.dir}/core/iedoc.xml" out="${image.dir}/reference.html" style="javascript/iedoc2html.xml"/>
    </target>

    <target name="dist-image" depends="get-svn-revision, copy-sources, generate-doc"/>

    <target name="dist" depends="dist-image">
        <mkdir dir="${dist.dir}"/>
        <property name="selenium-core-release" value="selenium-core-${version}"/>
        <zip destfile="${dist.dir}/${selenium-core-release}.zip">
            <zipfileset dir="${image.dir}" prefix="${selenium-core-release}"/>
        </zip>
    </target>

    <target name="resultshandler-image" depends="get-svn-revision, copy-sources"
            description="Creates a public test results handler image - this should be copied to an apache directory, preserving permissions.">
        <echo>
        Creating a public test results handler image for Selenium revision ${svn-revision} at
            ${resultshandler.image.dir}.
        This should be copied to an apache directory that is available via the URL "http://HOST${resultshandler.path.prefix}".
        Permissions must be preserved in the copy.
        </echo>
        <!-- Copy the image -->
        <copy todir="${resultshandler.image.dir}/selenium">
            <fileset dir="${image.dir}"/>
        </copy>

        <!-- Copy the results handler files with correct permissions -->
        <copy todir="${resultshandler.image.dir}">
            <fileset dir="resultshandler"/>
            <filterset>
                <filter token="PATH_PREFIX" value="${resultshandler.path.prefix}"/>
                <filter token="RUBY" value="${ruby.executable}"/>
            </filterset>
        </copy>
        <chmod perm="755">
            <fileset dir="${resultshandler.image.dir}">
                <include name="**/*.rb"/>
            </fileset>
        </chmod>
        <chmod perm="777">
            <dirset dir="${resultshandler.image.dir}">
                <include name="results"/>
            </dirset>
        </chmod>
        <chmod perm="666">
            <fileset dir="${resultshandler.image.dir}/results">
                <include name="index.html"/>
                <include name="results.list"/>
            </fileset>
        </chmod>
    </target>

    <target name="install-jar" depends="dist-image, maven-tasks">
        <mkdir dir="${dist.dir}"/>
        <jar destfile="dist/selenium-core.jar">
            <fileset dir="${image.dir}"/>
        </jar>
        <echo file="maven.project"><![CDATA[
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>org.openqa.selenium.core</groupId>
    <artifactId>selenium-core</artifactId>
    <version>${version}</version>
    <packaging>jar</packaging>
    <name>Selenium JavaScript Core</name>
    <url>http://www.openqa.org/selenium</url>
</project>
]]>
        </echo>
        <maven:pom id="maven.project" file="maven.project"/>
        <maveninst file="dist/selenium-core.jar">
            <pom refid="maven.project"/>
        </maveninst>
    </target>

    <target name="maven-tasks-base">
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
            <classpath>
                <pathelement location="maven-artifact-ant-2.0.2-dep.jar"/>
            </classpath>
        </typedef>
    </target>

    <target name="custom-repo" depends="maven-tasks-base" if="custom.maven.repo">
        <presetdef name="maveninst">
            <maven:install>
                <localRepository location="${custom.maven.repo}"/>
            </maven:install>
        </presetdef>
    </target>

    <target name="default-repo" depends="maven-tasks-base" unless="custom.maven.repo">
        <presetdef name="maveninst">
            <maven:install/>
        </presetdef>
    </target>

    <target name="maven-tasks" depends="custom-repo, default-repo"/>

</project>
